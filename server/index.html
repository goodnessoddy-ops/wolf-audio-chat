<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolf Audio Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a4d2e 0%, #2d5f3f 50%, #1a4d2e 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        .wolf-bg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 900px;
            height: 900px;
            opacity: 0.2;
            z-index: 0;
        }

        .main-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .title {
            text-align: center;
            color: white;
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .giant-button {
            width: 100%;
            max-width: 600px;
            margin: 30px auto;
            padding: 40px 60px;
            font-size: 36px;
            font-weight: 900;
            text-align: center;
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            color: #000;
            border: 5px solid #fff;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(0,255,0,0.5);
            display: block;
            transition: all 0.3s;
        }

        .giant-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 15px 50px rgba(0,255,0,0.7);
        }

        .giant-button.stop-btn {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            box-shadow: 0 10px 40px rgba(255,0,0,0.5);
        }

        .giant-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .chat-box {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            max-width: 700px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .message {
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-msg {
            background: linear-gradient(135deg, #1a4d2e 0%, #2d5f3f 100%);
            color: white;
            margin-left: auto;
        }

        .assistant-msg {
            background: #e0e0e0;
            color: #000;
        }

        .interim-msg {
            background: #f0f0f0;
            color: #999;
            font-style: italic;
            border: 2px dashed #ccc;
            margin-left: auto;
        }

        .status-bar {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            margin: 20px auto;
            max-width: 600px;
        }

        .listening {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .speaking {
            background: #fff9c4;
            color: #f57f17;
        }

        .thinking {
            background: #bbdefb;
            color: #1565c0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .visualizer {
            display: none;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            overflow: hidden;
        }

        .visualizer.active {
            display: block;
        }

        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            transition: width 0.1s ease;
            border-radius: 15px;
        }

        .empty-msg {
            text-align: center;
            color: #666;
            padding: 50px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <svg class="wolf-bg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <g fill="#ffffff">
            <ellipse cx="100" cy="80" rx="40" ry="45"/>
            <path d="M70 45 L60 20 Q58 15 63 13 Q68 12 72 18 L75 35 Z"/>
            <path d="M130 45 L140 20 Q142 15 137 13 Q132 12 128 18 L125 35 Z"/>
            <ellipse cx="100" cy="100" rx="25" ry="30"/>
            <circle cx="82" cy="75" r="9" fill="#000"/>
            <circle cx="84" cy="73" r="4" fill="#fff"/>
            <circle cx="118" cy="75" r="9" fill="#000"/>
            <circle cx="120" cy="73" r="4" fill="#fff"/>
            <ellipse cx="100" cy="105" rx="8" ry="10" fill="#000"/>
            <ellipse cx="100" cy="145" rx="45" ry="40"/>
            <rect x="65" y="165" width="15" height="50" rx="7"/>
            <rect x="120" y="165" width="15" height="50" rx="7"/>
        </g>
    </svg>

    <div class="main-container">
        <h1 class="title">üê∫ WOLF AUDIO CHAT üê∫</h1>

        <div class="status-bar" id="statusBar">
            üê∫ Ready - Click the button below!
        </div>

        <div class="visualizer" id="visualizer">
            <div class="volume-bar" id="volumeBar"></div>
        </div>

        <button class="giant-button" id="startButton">
            üé§ START LISTENING üé§
        </button>

        <button class="giant-button stop-btn" id="stopButton" style="display: none;">
            üõë STOP üõë
        </button>

        <div class="chat-box" id="chatBox">
            <div class="empty-msg" id="emptyMsg">
                üê∫ Hey there! I'm Wolf, your AI companion!<br><br>
                Click "START LISTENING" and ask me anything!<br><br>
                <small style="color: #999;">I can answer questions, have conversations, and understand emotions!</small>
            </div>
        </div>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusBar = document.getElementById('statusBar');
        const chatBox = document.getElementById('chatBox');
        const emptyMsg = document.getElementById('emptyMsg');
        const visualizer = document.getElementById('visualizer');
        const volumeBar = document.getElementById('volumeBar');

        let recognition;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let interimElement = null;
        let conversationHistory = [];

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                statusBar.textContent = 'üê∫ Listening... speak now!';
                statusBar.className = 'status-bar listening';
                visualizer.classList.add('active');
            };

            recognition.onresult = (event) => {
                if (synthesis.speaking) return;

                let interim = '';
                let final = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        final += event.results[i][0].transcript;
                    } else {
                        interim += event.results[i][0].transcript;
                    }
                }

                if (interim) {
                    showInterim(interim);
                }

                if (final && final.trim()) {
                    if (interimElement) {
                        interimElement.remove();
                        interimElement = null;
                    }
                    addMessage(final, 'user-msg');
                    recognition.stop();
                    getAIResponse(final);
                }
            };

            recognition.onerror = (event) => {
                console.error('Recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    alert(‚ö†Ô∏è Please allow microphone access!');
                    resetApp();
                }
            };

            recognition.onend = () => {
                visualizer.classList.remove('active');
                if (isListening && !synthesis.speaking) {
                    setTimeout(() => {
                        if (isListening && !synthesis.speaking) {
                            try {
                                recognition.start();
                            } catch (e) {}
                        }
                    }, 100);
                }
            };
        }

        function showInterim(text) {
            if (emptyMsg && emptyMsg.parentNode) {
                emptyMsg.remove();
            }
            if (!interimElement) {
                interimElement = document.createElement('div');
                interimElement.className = 'message interim-msg';
                chatBox.appendChild(interimElement);
            }
            interimElement.textContent = text + '...';
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addMessage(text, className) {
            if (emptyMsg && emptyMsg.parentNode) {
                emptyMsg.remove();
            }
            const msg = document.createElement('div');
            msg.className = 'message ' + className;
            msg.textContent = text;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function getAIResponse(userInput) {
            statusBar.textContent = 'ü§ñ Thinking...';
            statusBar.className = 'status-bar thinking';

            conversationHistory.push({
                role: 'user',
                content: userInput
            });

            try {
                console.log('üß† Calling AI...');

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: conversationHistory.map(m => ({
                            role: m.role,
                            content: m.content
                        })),
                        temperature: 0.8,
                        max_tokens: 150
                    })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error('API failed');
                }

                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content;
                    console.log('‚úÖ AI Response:', aiResponse);
                    
                    conversationHistory.push({
                        role: 'assistant',
                        content: aiResponse
                    });

                    addMessage(aiResponse, 'assistant-msg');
                    speak(aiResponse);
                    return;
                }
            } catch (error) {
                console.error('Error:', error);
            }

            const fallback = "I'm having trouble connecting right now, but I'm still here! Could you try again?";
            addMessage(fallback, 'assistant-msg');
            speak(fallback);
        }

        function speak(text) {
            statusBar.textContent = 'üê∫ Speaking...';
            statusBar.className = 'status-bar speaking';
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.92;
            utterance.pitch = 1.1;
            
            utterance.onstart = () => {
                if (recognition && isListening) {
                    try {
                        recognition.stop();
                    } catch (e) {}
                }
            };
            
            utterance.onend = () => {
                setTimeout(() => {
                    if (isListening) {
                        statusBar.textContent = 'üê∫ Listening...';
                        statusBar.className = 'status-bar listening';
                        try {
                            recognition.start();
                        } catch (e) {}
                    } else {
                        resetApp();
                    }
                }, 500);
            };
            
            synthesis.speak(utterance);
        }

        function resetApp() {
            isListening = false;
            startButton.style.display = 'block';
            stopButton.style.display = 'none';
            statusBar.textContent = 'üê∫ Ready!';
            statusBar.className = 'status-bar';
            visualizer.classList.remove('active');
        }

        startButton.addEventListener('click', async () => {
            console.log('üê∫ START clicked!');
            
            if (!recognition) {
                alert('Speech recognition not supported. Use Chrome, Edge, or Safari.');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: true
                    }
                });

                console.log('‚úÖ Microphone ready!');
                
                startButton.style.display = 'none';
                stopButton.style.display = 'block';
                
                isListening = true;
                recognition.start();

                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                function draw() {
                    if (!isListening) return;
                    requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);
                    const avg = dataArray.reduce((a,b) => a+b) / dataArray.length;
                    volumeBar.style.width = Math.min((avg / 255) * 200, 100) + '%';
                }
                draw();
                
            } catch (err) {
                console.error('Mic error:', err);
                alert('‚ö†Ô∏è Microphone access denied!');
            }
        });

        stopButton.addEventListener('click', () => {
            console.log('üê∫ STOP clicked!');
            isListening = false;
            if (recognition) recognition.stop();
            if (synthesis.speaking) synthesis.cancel();
            resetApp();
        });

        console.log('üê∫ Wolf ready!');
    </script>
</body>
</html>