<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolf Audio Chat - AI Powered</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: linear-gradient(135deg, #1a4d2e 0%, #2d5f3f 50%, #1a4d2e 100%);
            --bg-card: rgba(255,255,255,0.95);
            --text-primary: #000;
            --text-secondary: #666;
            --wolf-opacity: 0.2;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #0a1f14 0%, #1a3322 50%, #0a1f14 100%);
            --bg-card: rgba(30,30,30,0.95);
            --text-primary: #fff;
            --text-secondary: #aaa;
            --wolf-opacity: 0.1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            transition: background 0.3s ease;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
        }

        .wolf-bg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 900px;
            height: 900px;
            opacity: var(--wolf-opacity);
            z-index: 0;
            transition: opacity 0.3s ease;
        }

        @media (max-width: 768px) {
            .wolf-bg {
                width: 600px;
                height: 600px;
            }
        }

        .main-container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .title {
            text-align: center;
            color: white;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2em;
            }
        }

        .controls-panel {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .controls-panel {
                padding: 15px;
            }
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .control-group {
                min-width: 100%;
            }
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .control-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #1a4d2e;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #000;
            cursor: pointer;
        }

        [data-theme="dark"] .control-group select {
            background: #2a2a2a;
            color: #fff;
            border-color: #2d5f3f;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .icon-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            background: #1a4d2e;
            color: white;
        }

        .icon-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .icon-button.active {
            background: #ff6b6b;
        }

        @media (max-width: 768px) {
            .icon-button {
                flex: 1;
                min-width: calc(50% - 5px);
            }
        }

        .giant-button {
            width: 100%;
            max-width: 600px;
            margin: 30px auto;
            padding: 40px 60px;
            font-size: 36px;
            font-weight: 900;
            text-align: center;
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            color: #000;
            border: 5px solid #fff;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(0,255,0,0.5);
            display: block;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .giant-button {
                padding: 30px 40px;
                font-size: 24px;
            }
        }

        .giant-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 15px 50px rgba(0,255,0,0.7);
        }

        .giant-button:active:not(:disabled) {
            transform: scale(0.98);
        }

        .giant-button.stop-btn {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            box-shadow: 0 10px 40px rgba(255,0,0,0.5);
        }

        .giant-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .chat-box {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            max-width: 800px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .chat-box {
                padding: 15px;
                min-height: 300px;
                max-height: 400px;
            }
        }

        .message {
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
            line-height: 1.5;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-msg {
            background: linear-gradient(135deg, #1a4d2e 0%, #2d5f3f 100%);
            color: white;
            margin-left: auto;
        }

        .assistant-msg {
            background: #e0e0e0;
            color: #000;
        }

        [data-theme="dark"] .assistant-msg {
            background: #3a3a3a;
            color: #fff;
        }

        .interim-msg {
            background: #f0f0f0;
            color: #999;
            font-style: italic;
            border: 2px dashed #ccc;
            margin-left: auto;
        }

        [data-theme="dark"] .interim-msg {
            background: #2a2a2a;
            border-color: #555;
        }

        .status-bar {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            margin: 20px auto;
            max-width: 600px;
        }

        @media (max-width: 768px) {
            .status-bar {
                font-size: 16px;
                padding: 12px;
            }
        }

        [data-theme="dark"] .status-bar {
            background: rgba(30,30,30,0.9);
            color: #fff;
        }

        .listening {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .speaking {
            background: #fff9c4;
            color: #f57f17;
        }

        .thinking {
            background: #bbdefb;
            color: #1565c0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .visualizer {
            display: none;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            overflow: hidden;
        }

        .visualizer.active {
            display: block;
        }

        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            transition: width 0.1s ease;
            border-radius: 15px;
        }

        .empty-msg {
            text-align: center;
            color: var(--text-secondary);
            padding: 50px;
            font-size: 18px;
            line-height: 1.6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .close-button {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: var(--text-primary);
        }


    </style>
</head>
<body>
    <svg class="wolf-bg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <g fill="#ffffff">
            <ellipse cx="100" cy="80" rx="40" ry="45"/>
            <path d="M70 45 L60 20 Q58 15 63 13 Q68 12 72 18 L75 35 Z"/>
            <path d="M130 45 L140 20 Q142 15 137 13 Q132 12 128 18 L125 35 Z"/>
            <ellipse cx="100" cy="100" rx="25" ry="30"/>
            <circle cx="82" cy="75" r="9" fill="#000"/>
            <circle cx="84" cy="73" r="4" fill="#fff"/>
            <circle cx="118" cy="75" r="9" fill="#000"/>
            <circle cx="120" cy="73" r="4" fill="#fff"/>
            <ellipse cx="100" cy="105" rx="8" ry="10" fill="#000"/>
            <path d="M100 105 Q95 112 88 110 M100 105 Q105 112 112 110" stroke="#000" stroke-width="3" fill="none"/>
            <ellipse cx="100" cy="145" rx="45" ry="40"/>
            <rect x="65" y="165" width="15" height="50" rx="7"/>
            <rect x="120" y="165" width="15" height="50" rx="7"/>
        </g>
    </svg>

    <div class="main-container">
        <h1 class="title">üê∫ WOLF AUDIO CHAT üê∫</h1>

        <div class="controls-panel">
            <div class="control-row">
                <div class="control-group">
                    <label for="modelSelect">‚ö° AI Model</label>
                    <select id="modelSelect">
                        <option value="llama-3.3-70b-versatile">‚ö° Fast</option>
                        <option value="llama-3.1-70b-versatile">‚öñÔ∏è Balanced</option>
                        <option value="mixtral-8x7b-32768">üß† Smart</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="personalitySelect">üé≠ Personality</label>
                    <select id="personalitySelect">
                        <option value="friendly">Friendly & Warm</option>
                        <option value="professional">Professional</option>
                        <option value="funny">Funny & Humorous</option>
                        <option value="serious">Serious & Direct</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="languageSelect">üåç Language</label>
                    <select id="languageSelect">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="pcm-NG">Nigerian Pidgin</option>
                        <option value="yo-NG">Yoruba</option>
                        <option value="ig-NG">Igbo</option>
                        <option value="ha-NG">Hausa</option>
                        <option value="es-ES">Espa√±ol</option>
                        <option value="fr-FR">Fran√ßais</option>
                        <option value="de-DE">Deutsch</option>
                        <option value="it-IT">Italiano</option>
                        <option value="pt-BR">Portugu√™s</option>
                        <option value="ja-JP">Êó•Êú¨Ë™û</option>
                        <option value="zh-CN">‰∏≠Êñá</option>
                    </select>
                </div>
            </div>
            <div class="control-row">
                <div class="button-group">
                    <button class="icon-button" id="themeToggle">üåô Dark Mode</button>
                    <button class="icon-button" id="muteToggle">üîä Voice On</button>
                    <button class="icon-button" id="historyButton">üìù History</button>
                    <button class="icon-button" id="clearButton">üóëÔ∏è Clear Chat</button>
                </div>
            </div>
        </div>

        <div class="status-bar" id="statusBar">
            üê∫ Ready to chat - Click start below!
        </div>

        <div class="visualizer" id="visualizer">
            <div class="volume-bar" id="volumeBar"></div>
        </div>

        <button class="giant-button" id="startButton">
            üé§ START LISTENING üé§
        </button>

        <button class="giant-button stop-btn" id="stopButton" style="display: none;">
            üõë STOP üõë
        </button>

        <div class="chat-box" id="chatBox">
            <div class="empty-msg" id="emptyMsg">
                üê∫ Hello there! I'm Wolf, your AI companion!<br><br>
                Click "START LISTENING" and ask me anything you'd like.<br><br>
                <small style="color: var(--text-secondary);">I can answer questions, have natural conversations, and understand your emotions!</small>
            </div>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìù Conversation History</div>
                <button class="close-button" id="closeModal">&times;</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusBar = document.getElementById('statusBar');
        const chatBox = document.getElementById('chatBox');
        const emptyMsg = document.getElementById('emptyMsg');
        const visualizer = document.getElementById('visualizer');
        const volumeBar = document.getElementById('volumeBar');
        const modelSelect = document.getElementById('modelSelect');
        const personalitySelect = document.getElementById('personalitySelect');
        const languageSelect = document.getElementById('languageSelect');
        const themeToggle = document.getElementById('themeToggle');
        const muteToggle = document.getElementById('muteToggle');
        const historyButton = document.getElementById('historyButton');
        const clearButton = document.getElementById('clearButton');
        const historyModal = document.getElementById('historyModal');
        const closeModal = document.getElementById('closeModal');
        const historyList = document.getElementById('historyList');

        // Backend API endpoint
        const API_ENDPOINT = 'https://wolf-audio-chat.onrender.com/api/chat';

        let recognition;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let interimElement = null;
        let conversationHistory = [];
        let audioContext;
        let analyser;
        let microphone;
        let isMuted = false;
        let savedConversations = JSON.parse(localStorage.getItem('wolfConversations') || '[]');

        const personalities = {
            friendly: 'You are Wolf, a warm, friendly, and highly articulate AI voice assistant. Keep your answers concise (2-3 sentences) since they\'ll be read aloud. Use perfect, fluent English with natural flow. Be empathetic and genuinely interested in helping.',
            professional: 'You are Wolf, a professional and efficient AI assistant. Provide clear, concise information in a business-like tone. Keep responses brief (2-3 sentences).',
            funny: 'You are Wolf, a witty and humorous AI assistant. Make conversations fun with clever jokes. Keep it light (2-3 sentences) but always helpful.',
            serious: 'You are Wolf, a serious and direct AI assistant. Provide straightforward, factual responses. Be concise (2-3 sentences), precise, and to the point.'
        };

        const languageNames = {
            'en-US': 'English', 'en-GB': 'English',
            'es-ES': 'Spanish', 'fr-FR': 'French', 'de-DE': 'German',
            'it-IT': 'Italian', 'pt-BR': 'Portuguese', 'ja-JP': 'Japanese', 'zh-CN': 'Chinese'
        };

        const savedTheme = localStorage.getItem('wolfTheme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';

        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('wolfTheme', newTheme);
            themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        });

        muteToggle.addEventListener('click', () => {
            isMuted = !isMuted;
            muteToggle.textContent = isMuted ? 'üîá Voice Off' : 'üîä Voice On';
            muteToggle.classList.toggle('active');
        });

        clearButton.addEventListener('click', () => {
            if (confirm('Clear current conversation?')) {
                conversationHistory = [];
                chatBox.innerHTML = '<div class="empty-msg">üê∫ Chat cleared!</div>';
            }
        });

        historyButton.addEventListener('click', () => {
            displayHistory();
            historyModal.classList.add('active');
        });

        closeModal.addEventListener('click', () => historyModal.classList.remove('active'));
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) historyModal.classList.remove('active');
        });

        function displayHistory() {
            if (savedConversations.length === 0) {
                historyList.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No saved conversations yet.</p>';
                return;
            }
            historyList.innerHTML = savedConversations.map((conv, i) => `
                <div style="padding:15px;margin:10px 0;background:rgba(26,77,46,0.1);border-left:4px solid #1a4d2e;border-radius:5px;cursor:pointer;" onclick="loadConversation(${i})">
                    <div style="font-weight:600;color:var(--text-primary);margin-bottom:5px;">${conv.title}</div>
                    <div style="font-size:14px;color:var(--text-secondary);">${conv.preview}</div>
                </div>
            `).join('');
        }

        window.loadConversation = (i) => {
            const conv = savedConversations[i];
            conversationHistory = conv.messages;
            chatBox.innerHTML = '';
            conv.messages.forEach(msg => addMessage(msg.content, msg.role === 'user' ? 'user-msg' : 'assistant-msg'));
            historyModal.classList.remove('active');
        };

        function saveConversation() {
            if (conversationHistory.length < 2) return;
            savedConversations.unshift({
                title: new Date().toLocaleString(),
                preview: conversationHistory[0].content.substring(0, 50) + '...',
                messages: [...conversationHistory],
                timestamp: Date.now()
            });
            if (savedConversations.length > 20) savedConversations = savedConversations.slice(0, 20);
            localStorage.setItem('wolfConversations', JSON.stringify(savedConversations));
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            languageSelect.addEventListener('change', () => recognition.lang = languageSelect.value);
            recognition.lang = languageSelect.value;

            recognition.onstart = () => {
                isListening = true;
                statusBar.textContent = 'üê∫ I\'m listening!';
                statusBar.className = 'status-bar listening';
                visualizer.classList.add('active');
            };

            recognition.onresult = (event) => {
                if (synthesis.speaking) return;
                let interim = '', final = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) final += transcript;
                    else interim += transcript;
                }
                if (interim) showInterim(interim);
                if (final && final.trim()) {
                    if (interimElement) {
                        interimElement.remove();
                        interimElement = null;
                    }
                    addMessage(final, 'user-msg');
                    recognition.stop();
                    getAIResponse(final);
                }
            };

            recognition.onerror = (event) => {
                if (event.error === 'not-allowed') {
                    alert('‚ö†Ô∏è Microphone access denied! Please allow access and refresh.');
                    resetApp();
                } else if (event.error === 'audio-capture') {
                    alert('‚ùå Microphone error! Check your device.');
                    resetApp();
                }
            };

            recognition.onend = () => {
                visualizer.classList.remove('active');
                if (isListening && !synthesis.speaking) {
                    setTimeout(() => {
                        if (isListening && !synthesis.speaking) {
                            try { recognition.start(); } catch (e) {}
                        }
                    }, 100);
                }
            };
        }

        function showInterim(text) {
            if (emptyMsg && emptyMsg.parentNode) emptyMsg.remove();
            if (!interimElement) {
                interimElement = document.createElement('div');
                interimElement.className = 'message interim-msg';
                chatBox.appendChild(interimElement);
            }
            interimElement.textContent = text + '...';
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addMessage(text, className) {
            if (emptyMsg && emptyMsg.parentNode) emptyMsg.remove();
            const msg = document.createElement('div');
            msg.className = 'message ' + className;
            msg.textContent = text;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function getAIResponse(userInput) {
            statusBar.textContent = 'ü§ñ Thinking...';
            statusBar.className = 'status-bar thinking';

            conversationHistory.push({ role: 'user', content: userInput });

            const lang = languageSelect.value;
            const langName = languageNames[lang];
            const personality = personalities[personalitySelect.value];
            const systemPrompt = personality + (lang !== 'en-US' && lang !== 'en-GB' ? ` Always respond in ${langName}.` : '');

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: modelSelect.value,
                        messages: [{ role: 'system', content: systemPrompt }, ...conversationHistory],
                        temperature: 0.8,
                        max_tokens: 150
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content;
                    conversationHistory.push({ role: 'assistant', content: aiResponse });
                    addMessage(aiResponse, 'assistant-msg');
                    if (!isMuted) speak(aiResponse);
                    if (conversationHistory.length % 4 === 0) saveConversation();
                } else throw new Error('Invalid response');
            } catch (error) {
                console.error('AI Error:', error);
                conversationHistory.pop();
                const errMsg = "I encountered a hiccup. Try again?";
                addMessage(errMsg, 'assistant-msg');
                if (!isMuted) speak(errMsg);
            }
        }

        function speak(text) {
            if (isMuted) {
                setTimeout(() => {
                    if (isListening) {
                        statusBar.textContent = 'üê∫ I\'m listening...';
                        statusBar.className = 'status-bar listening';
                        try { recognition.start(); } catch (e) {}
                    } else resetApp();
                }, 500);
                return;
            }

            statusBar.textContent = 'üê∫ Speaking...';
            statusBar.className = 'status-bar speaking';
            synthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.95;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;

            const lang = languageSelect.value;
            const voices = synthesis.getVoices();
            const langVoices = voices.filter(v => v.lang.startsWith(lang.split('-')[0]));
            const voice = langVoices.find(v => v.name.includes('Natural') || v.name.includes('Enhanced')) || langVoices[0] || voices.find(v => v.lang.startsWith('en'));
            if (voice) {
                utterance.voice = voice;
                utterance.lang = lang;
            }

            utterance.onstart = () => {
                if (recognition && isListening) {
                    try { recognition.stop(); } catch (e) {}
                }
            };

            utterance.onend = () => {
                setTimeout(() => {
                    if (isListening) {
                        statusBar.textContent = 'üê∫ I\'m listening...';
                        statusBar.className = 'status-bar listening';
                        try { recognition.start(); } catch (e) {}
                    } else resetApp();
                }, 500);
            };

            synthesis.speak(utterance);
        }

        function resetApp() {
            isListening = false;
            startButton.style.display = 'block';
            stopButton.style.display = 'none';
            statusBar.textContent = 'üê∫ Ready when you are!';
            statusBar.className = 'status-bar';
            visualizer.classList.remove('active');
            if (microphone) microphone.disconnect();
            if (audioContext && audioContext.state !== 'closed') audioContext.close();
            if (conversationHistory.length > 0) saveConversation();
        }

        startButton.addEventListener('click', async () => {
            if (!recognition) {
                alert('‚ùå Speech recognition not supported! Use Chrome, Edge, or Safari.');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                });

                startButton.style.display = 'none';
                stopButton.style.display = 'block';
                isListening = true;
                recognition.start();

                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;

                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function draw() {
                    if (!isListening) return;
                    requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);
                    const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    volumeBar.style.width = Math.min((avg / 255) * 200, 100) + '%';
                }
                draw();
            } catch (err) {
                console.error('Microphone error:', err);
                if (err.name === 'NotAllowedError') {
                    alert('‚ö†Ô∏è Microphone access denied!\n\nPlease:\n1. Click lock icon in address bar\n2. Allow microphone\n3. Refresh and try again');
                } else if (err.name === 'NotFoundError') {
                    alert('‚ùå No microphone found! Please connect one.');
                } else {
                    alert('‚ùå Microphone error: ' + err.message);
                }
                resetApp();
            }
        });

        stopButton.addEventListener('click', () => {
            isListening = false;
            if (recognition) recognition.stop();
            if (synthesis.speaking) synthesis.cancel();
            resetApp();
        });

        if (synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = () => console.log('Voices loaded:', synthesis.getVoices().length);
        }

        console.log('‚úÖ Wolf Audio Chat ready!');
    </script>
</body>
</html>